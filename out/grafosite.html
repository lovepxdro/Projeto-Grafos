<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Grafo de Bairros - Recife</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <script src="grafosite_data.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      #mynetwork { width:100%; height:700px; background:#fff; border:1px solid #e9ecef; border-radius:.5rem; }
      .input-group > input::placeholder { color:#6c757d; }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2">
        <h3 class="m-0">Grafo de Bairros</h3>
        <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
          <div class="input-group input-group-sm" style="max-width:420px;">
            <input id="searchInput" class="form-control" list="bairroList" placeholder="Buscar bairro…" />
            <datalist id="bairroList"></datalist>
            <button id="searchBtn" class="btn btn-outline-primary">Buscar</button>
          </div>
          <div class="d-flex gap-2">
            <button id="showArvoreBtn" class="btn btn-sm btn-outline-primary" title="Abrir árvore de percurso">ND → BV</button>
            <button id="resetBtn" class="btn btn-sm btn-outline-secondary" title="Restaurar grafo completo">Resetar</button>
            <button id="fitBtn" class="btn btn-sm btn-outline-secondary">Ajustar à tela</button>
            <button id="physicsBtn" class="btn btn-sm btn-secondary">Física: on</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container pb-4">
      <div class="card shadow-sm border-0"><div class="card-body p-2 p-md-3"><div id="mynetwork"></div></div></div>
    </div>
    <script>
      const ADJ_CSV_URL = '../data/adjacencias_bairros.csv';
      var edges, nodes, allNodes, allEdges, nodeColors, network;
      var highlightActive=false, filterActive=false;

      async function fetchCSV(url){ try { const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.text(); } catch(e){ console.warn('Falha ao carregar CSV', e); return null; } }

      async function drawGraph(){
        const container = document.getElementById('mynetwork');
        let built = { nodes:[], edges:[] };
        if (typeof NODES !== 'undefined' && typeof EDGES !== 'undefined') {
          nodes = new vis.DataSet(NODES); edges = new vis.DataSet(EDGES);
        } else {
          const csvText = await fetchCSV(ADJ_CSV_URL);
          built = parseAdj(csvText);
          nodes = new vis.DataSet(built.nodes); edges = new vis.DataSet(built.edges);
          if (!csvText){ const warn=document.createElement('div'); warn.textContent='Falha ao carregar CSV.'; warn.style.cssText='position:absolute;top:10px;left:10px;background:#ffc107;padding:4px 8px;border-radius:4px;font-size:12px;'; container.appendChild(warn); }
        }
        nodeColors={}; allNodes = nodes.get({returnType:'Object'}); for (let id in allNodes){ nodeColors[id]=allNodes[id].color; }
        allEdges = edges.get({returnType:'Object'});
        const options={ edges:{ arrows:{to:{enabled:false}}, color:{inherit:false,color:'#ff6b35',highlight:'#ff3b30',hover:'#ff8a5b',opacity:0.9}, smooth:{enabled:true,type:'dynamic',roundness:0.3}, width:3 }, interaction:{ hover:true }, physics:{ enabled:true, stabilization:{ enabled:true, iterations:1000, fit:true } } };
        network = new vis.Network(container,{nodes,edges},options);
        computeMetricsAndTooltips();
        buildSearchDatalist();
        wireControls();
        return network;
      }

      function parseAdj(csvText){ if(!csvText) return {nodes:[],edges:[]}; const lines=csvText.trim().split(/\r?\n/); if(lines.length<=1) return {nodes:[],edges:[]}; const header=lines[0].split(',').map(s=>s.trim()); const iO=header.indexOf('bairro_origem'); const iD=header.indexOf('bairro_destino'); const iL=header.indexOf('logradouro'); const iP=header.indexOf('peso'); const nodeMap=new Map(); const edgesArr=[]; const added=new Set(); for(let i=1;i<lines.length;i++){ const raw=lines[i].trim(); if(!raw) continue; const cols=raw.split(','); if(cols.length<5) continue; const u=(cols[iO]||'').trim(); const v=(cols[iD]||'').trim(); const logr=(cols[iL]||'').trim(); const w=parseFloat((cols[iP]||'1.0').trim())||1.0; if(u&&!nodeMap.has(u)) nodeMap.set(u,{id:u,label:u,shape:'dot',color:'#97c2fc',title:`Bairro: ${u}<br>Microrregião: DESCONHECIDA`}); if(v&&!nodeMap.has(v)) nodeMap.set(v,{id:v,label:v,shape:'dot',color:'#97c2fc',title:`Bairro: ${v}<br>Microrregião: DESCONHECIDA`}); if(u&&v){ const key=[u,v].sort().join('||'); if(!added.has(key)){ added.add(key); edgesArr.push({from:u,to:v,value:isFinite(w)?w:1.0,title:`${u} <-> ${v}<br>Peso: ${isFinite(w)?w:1.0}<br>Logradouro: ${logr}`,color:'#ff6b35'}); } } } return {nodes:[...nodeMap.values()],edges:edgesArr}; }

      function computeMetricsAndTooltips(){ try { const nodeIds=nodes.getIds(); const neigh={}; nodeIds.forEach(id=> neigh[id]=new Set()); edges.get().forEach(e=>{ if(neigh[e.from]) neigh[e.from].add(e.to); if(neigh[e.to]) neigh[e.to].add(e.from); }); function egoDensity(v){ const S=new Set([v]); neigh[v].forEach(u=>S.add(u)); const N=S.size; if(N<2) return 0; const inS={}; [...S].forEach(x=> inS[x]=true); let E=0; edges.get().forEach(e=>{ if(inS[e.from]&&inS[e.to]) E++; }); return (2*E)/(N*(N-1)); } const updates=[]; nodes.get().forEach(n=>{ const degree=neigh[n.id]?neigh[n.id].size:0; const dens=egoDensity(n.id); const micro = '-'; updates.push({id:n.id,title:`Bairro: ${n.label}<br>Microrregião: ${micro}<br>Grau: ${degree}<br>Densidade (ego): ${dens.toFixed(3)}`,degree,ego_density:dens,microrregiao:micro}); }); nodes.update(updates); }catch(_){} }

      function buildSearchDatalist(){ try { const list=document.getElementById('bairroList'); if(!list) return; list.innerHTML = nodes.get().map(n=> `<option value="${(n.label||n.id).replace(/"/g,'&quot;')}"></option>`).join(''); }catch(_){} }

      function isolateSelected(nodeId){ try { const neighborIds=network.getConnectedNodes(nodeId)||[]; const keep=[nodeId,...neighborIds]; const keepSet={}; keep.forEach(id=> keepSet[id]=true); const allObj=nodes.get({returnType:'Object'}); const nu=[]; for(let id in allObj){ if(!allObj.hasOwnProperty(id)) continue; if(keepSet[id]){ let lbl=allObj[id].label; if(allObj[id].hiddenLabel!==undefined) lbl=allObj[id].hiddenLabel; if(allObj[id].savedLabel!==undefined) lbl=allObj[id].savedLabel; nu.push({id,hidden:false,label:lbl,color:nodeColors[id]||allObj[id].color}); } else { nu.push({id,hidden:true}); } } nodes.update(nu); const eu=[]; edges.get().forEach(e=> eu.push({id:e.id,hidden: !(e.from===nodeId||e.to===nodeId)})); edges.update(eu); network.selectNodes([nodeId]); network.fit({nodes:keep,animation:{duration:500,easing:'easeInOutQuad'}}); }catch(_){} }

      function findNodeIdByLabel(q){ if(!q) return null; q=q.trim().toLowerCase(); const exact=nodes.get().filter(n=> (n.label||n.id).toString().toLowerCase()===q); if(exact.length===1) return exact[0].id; const part=nodes.get().filter(n=> (n.label||n.id).toString().toLowerCase().includes(q)); return part.length===1?part[0].id:null; }
      function focusAndSelect(id){ if(!id) return; isolateSelected(id); }

      function wireControls(){
        const fitBtn=document.getElementById('fitBtn'); if(fitBtn) fitBtn.addEventListener('click',()=> network.fit({animation:{duration:500,easing:'easeInOutQuad'}}));
        const physicsBtn=document.getElementById('physicsBtn'); let phys=true; if(physicsBtn) physicsBtn.addEventListener('click',()=>{ phys=!phys; network.setOptions({physics:{enabled:phys}}); physicsBtn.textContent='Física: '+(phys?'on':'off'); });
        const searchBtn=document.getElementById('searchBtn'); const searchInput=document.getElementById('searchInput'); if(searchBtn&&searchInput){ const handler=()=>{ const id=findNodeIdByLabel(searchInput.value); if(id) focusAndSelect(id); }; searchBtn.addEventListener('click',handler); searchInput.addEventListener('keydown',ev=>{ if(ev.key==='Enter') handler(); }); }
        const resetBtn=document.getElementById('resetBtn'); if(resetBtn) resetBtn.addEventListener('click', resetGraph);
        const showArvoreBtn=document.getElementById('showArvoreBtn'); if(showArvoreBtn) showArvoreBtn.addEventListener('click',()=>{ const modalEl=document.getElementById('arvoreModal'); if(modalEl){ const iframe=document.getElementById('arvoreFrame'); if(iframe) iframe.src='arvore_percurso.html'; new bootstrap.Modal(modalEl).show(); } else { window.open('arvore_percurso.html','_blank'); } });
      }

      function resetGraph(){ try { const edgeRes=[]; edges.get().forEach(e=> edgeRes.push({id:e.id,hidden:false,color:{ color:'#ff6b35', highlight:'#ff3b30', hover:'#ff8a5b', opacity:0.9 },width:3 })); edges.update(edgeRes); const all=nodes.get({returnType:'Object'}); const up=[]; for(let nid in all){ if(!all.hasOwnProperty(nid)) continue; const n=all[nid]; n.hidden=false; n.color=nodeColors[nid]||n.color; if(n.savedLabel!==undefined){ n.label=n.savedLabel; n.savedLabel=undefined; } if(n.hiddenLabel!==undefined){ n.label=n.hiddenLabel; n.hiddenLabel=undefined; } up.push(n); } nodes.update(up); highlightActive=false; filterActive=false; network.unselectAll(); network.fit({animation:{duration:500,easing:'easeInOutQuad'}}); }catch(_){} }

      drawGraph();
    </script>
    <div class="modal fade" id="arvoreModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Árvore de Percurso (Nova Descoberta → Boa Viagem)</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-0" style="height:75vh;"><iframe id="arvoreFrame" src="about:blank" style="border:0;width:100%;height:100%;"></iframe></div><div class="modal-footer"><a class="btn btn-sm btn-outline-secondary" href="arvore_percurso.html" target="_blank">Abrir em nova aba</a><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button></div></div></div>
    </div>
  </body>
</html>
